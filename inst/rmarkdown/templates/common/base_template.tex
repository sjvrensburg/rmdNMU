% Common base template
% ./inst/rmarkdown/templates/common/base_template.tex
%
% ARCHITECTURE NOTES:
% This template provides universal compatibility across all document types.
% - Conditional package loading prevents Beamer conflicts
% - Conditional command definitions eliminate redefinition errors
% - Universal Pandoc compatibility layer works with all document classes
%
% INHERITANCE HIERARCHY:
% - Assignment templates: inherit via \input{$base_template$}
% - Test templates: inherit via \input{$base_template$}
% - Practical templates: inherit via \input{$base_template$}
% - Beamer template: inherits via \input{$base_template$} with class-specific conditionals

% Essential Packages (load order optimised for dependencies)
\usepackage{iftex}
\usepackage{fontspec}        % Font management

% Document-class-specific packages (avoid Beamer conflicts)
% The geometry package conflicts with Beamer's frame layout system
\makeatletter
\@ifclassloaded{beamer}{}{%
  % Non-Beamer packages only
  \usepackage[a4paper, margin=2.54cm]{geometry}        % Page layout
}
\makeatother

\usepackage{xcolor}         % Colour support
\usepackage{graphicx}       % Graphics
\usepackage[protrusion=true]{microtype}

% Math and Symbols
\usepackage{amsmath}        % Core math
\usepackage{amssymb}        % Math symbols
\usepackage{mathtools}
\usepackage{unicode-math}   % Unicode math support
\usepackage{amsfonts}       % Additional math fonts
\usepackage[Scale=0.98,math-style=french]{lete-sans-math}

% Tables and Lists
\usepackage{array}          % Enhanced table support
\usepackage{booktabs}       % Professional tables
\usepackage{multirow}       % Complex table layouts
\usepackage{enumitem}       % List customisation

% Beamer doesn't support multi-page tables (frames are single pages)
\makeatletter
\@ifclassloaded{beamer}{}{%
  % Non-Beamer table packages
  \usepackage{longtable}      % Multi-page tables
}
\makeatother

% Links and References
\usepackage{hyperref}       % Load late for compatibility
\usepackage{bookmark}       % PDF bookmarks
\usepackage{cleveref}       % Smart cross-references
\usepackage{xurl}          % URL handling

% Code and Verbatim
\usepackage{fancyvrb}      % Verbatim text
\usepackage{fvextra}       % Extended verbatim
\usepackage{upquote}       % Proper quotes in verbatim
\usepackage[scale=0.95]{FiraMono}
\usepackage[verbatim]{lstfiracode}  % Code listings

% Additional packages for enhanced Pandoc compatibility
\usepackage{ulem}          % Strikethrough text support
\usepackage{fixltx2e}      % LaTeX2e fixes
\usepackage{emoji}

% Beamer has its own caption, spacing, and section formatting systems
\makeatletter
\@ifclassloaded{beamer}{}{%
  % Non-Beamer layout and formatting packages
  \usepackage{caption}       % Enhanced caption formatting
  \usepackage{setspace}      % Line spacing
  \usepackage{parskip}       % Paragraph spacing
  \usepackage{titlesec}      % Section formatting
}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Universal Pandoc Compatibility Layer
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatletter

% Core Pandoc boundary command
\@ifundefined{pandocbounded}{%
  \newcommand{\pandocbounded}[1]{#1}%
}{}

% List formatting command
\@ifundefined{tightlist}{%
  \newcommand{\tightlist}{%
    \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}%
}{}

% Image scaling commands (universal compatibility)
\@ifundefined{maxwidth}{%
  \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}%
}{}
\@ifundefined{maxheight}{%
  \def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}%
}{}

% Text formatting commands (conditional)
\@ifundefined{textbf}{}{\let\pandoctextbf\textbf}
\@ifundefined{textit}{}{\let\pandoctextit\textit}
\@ifundefined{texttt}{}{\let\pandoctexttt\texttt}
\@ifundefined{textem}{%
  \newcommand{\textem}[1]{\emph{#1}}%
}{}

% Strikethrough text support
\@ifundefined{sout}{%
  \newcommand{\sout}[1]{\sout{#1}}%
}{}

% Superscript and subscript handling
\@ifundefined{textsuperscript}{%
  \newcommand{\textsuperscript}[1]{\ensuremath{^{\text{#1}}}}%
}{}
\@ifundefined{textsubscript}{%
  \newcommand{\textsubscript}[1]{\ensuremath{_{\text{#1}}}}%
}{}

\makeatother

% Apply image scaling globally
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}

% Code block environment definitions for syntax highlighting
% Note: \VerbBar and \VERB are now handled by pandoc-compat.tex
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}

% Syntax highlighting colour definitions (conditional)
\makeatletter
\@ifundefined{AlertTok}{%
  \newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}%
}{}
\@ifundefined{AnnotationTok}{%
  \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}%
}{}
\@ifundefined{AttributeTok}{%
  \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}%
}{}
\@ifundefined{BaseNTok}{%
  \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}%
}{}
\@ifundefined{BuiltInTok}{%
  \newcommand{\BuiltInTok}[1]{#1}%
}{}
\@ifundefined{CharTok}{%
  \newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}%
}{}
\@ifundefined{CommentTok}{%
  \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}%
}{}
\@ifundefined{CommentVarTok}{%
  \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}%
}{}
\@ifundefined{ConstantTok}{%
  \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}%
}{}
\@ifundefined{ControlFlowTok}{%
  \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}%
}{}
\@ifundefined{DataTypeTok}{%
  \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}%
}{}
\@ifundefined{DecValTok}{%
  \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}%
}{}
\@ifundefined{DocumentationTok}{%
  \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}%
}{}
\@ifundefined{ErrorTok}{%
  \newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}%
}{}
\@ifundefined{ExtensionTok}{%
  \newcommand{\ExtensionTok}[1]{#1}%
}{}
\@ifundefined{FloatTok}{%
  \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}%
}{}
\@ifundefined{FunctionTok}{%
  \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}%
}{}
\@ifundefined{ImportTok}{%
  \newcommand{\ImportTok}[1]{#1}%
}{}
\@ifundefined{InformationTok}{%
  \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}%
}{}
\@ifundefined{KeywordTok}{%
  \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}%
}{}
\@ifundefined{NormalTok}{%
  \newcommand{\NormalTok}[1]{#1}%
}{}
\@ifundefined{OperatorTok}{%
  \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}%
}{}
\@ifundefined{OtherTok}{%
  \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}%
}{}
\@ifundefined{PreprocessorTok}{%
  \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}%
}{}
\@ifundefined{RegionMarkerTok}{%
  \newcommand{\RegionMarkerTok}[1]{#1}%
}{}
\@ifundefined{SpecialCharTok}{%
  \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}%
}{}
\@ifundefined{SpecialStringTok}{%
  \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}%
}{}
\@ifundefined{StringTok}{%
  \newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}%
}{}
\@ifundefined{VariableTok}{%
  \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}%
}{}
\@ifundefined{VerbatimStringTok}{%
  \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}%
}{}
\@ifundefined{WarningTok}{%
  \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}%
}{}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% End Universal Pandoc Compatibility Layer
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Enhanced table formatting for complex statistical output
\makeatletter
\def\fnum@table{\tablename~\thetable}
\makeatother

% Column type definitions for advanced table layouts
\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}

% Mathematical notation enhancement
\emergencystretch 3em

% Unicode character support enhancement
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi

% Hyperlink formatting enhancement
\hypersetup{
    colorlinks=true,
    linkcolor=nmusecondaryblue,
    filecolor=nmuprimaryblue,
    urlcolor=nmusecondaryblue,
    citecolor=nmuprimaryblue,
}

% URL line break handling
\IfFileExists{xurl.sty}{\usepackage{xurl}}{}
\urlstyle{same} % disable monospaced font for URLs

% List environment compatibility enhancements
\setlistdepth{20}
\renewlist{itemize}{itemize}{20}
\renewlist{enumerate}{enumerate}{20}

% Compact list environments for statistical output
\setlist[itemize]{noitemsep}
\setlist[enumerate]{noitemsep}
\setlist[description]{style=unboxed,leftmargin=0cm,itemindent=\parindent,listparindent=\parindent}

% Definition list support for statistical terminology
\newcommand{\term}[1]{\textbf{#1}}
\newcommand{\definition}[1]{\textit{#1}}

% Core font setup
\defaultfontfeatures{
    Ligatures=TeX,
    UprightFeatures={Weight=400},
    BoldFeatures={Weight=700},
    ItalicFeatures={Weight=400},
    BoldItalicFeatures={Weight=700}
}

% Unicode fallback without affecting main branding
\newfontfamily\unicodeext{DejaVu Serif}[
  Scale=MatchLowercase,
  Range={0250-02AF}  % IPA Extensions only
]
\usepackage{newunicodechar}
% Lowercase Greek letters
\newunicodechar{α}{{\unicodeext α}}  % Alpha - significance level, learning rate
\newunicodechar{β}{{\unicodeext β}}  % Beta - regression coefficients, Type II error
\newunicodechar{γ}{{\unicodeext γ}}  % Gamma - gamma function, regularisation parameter
\newunicodechar{δ}{{\unicodeext δ}}  % Delta - small change, Kronecker delta
\newunicodechar{ε}{{\unicodeext ε}}  % Epsilon - error term, small positive number
\newunicodechar{ζ}{{\unicodeext ζ}}  % Zeta - Riemann zeta function
\newunicodechar{η}{{\unicodeext η}}  % Eta - learning rate, efficiency
\newunicodechar{θ}{{\unicodeext θ}}  % Theta - angle, parameter vector
\newunicodechar{ι}{{\unicodeext ι}}  % Iota - inclusion operator
\newunicodechar{κ}{{\unicodeext κ}}  % Kappa - curvature, condition number
\newunicodechar{λ}{{\unicodeext λ}}  % Lambda - eigenvalue, regularisation parameter
\newunicodechar{μ}{{\unicodeext μ}}  % Mu - population mean, measure
\newunicodechar{ν}{{\unicodeext ν}}  % Nu - degrees of freedom, frequency
\newunicodechar{ξ}{{\unicodeext ξ}}  % Xi - random variable
\newunicodechar{π}{{\unicodeext π}}  % Pi - 3.14159..., probability
\newunicodechar{ρ}{{\unicodeext ρ}}  % Rho - correlation coefficient, density
\newunicodechar{σ}{{\unicodeext σ}}  % Sigma - standard deviation, summation
\newunicodechar{τ}{{\unicodeext τ}}  % Tau - time constant, 2π
\newunicodechar{υ}{{\unicodeext υ}}  % Upsilon - degrees of freedom
\newunicodechar{φ}{{\unicodeext φ}}  % Phi - golden ratio, normal distribution
\newunicodechar{χ}{{\unicodeext χ}}  % Chi - chi-squared distribution
\newunicodechar{ψ}{{\unicodeext ψ}}  % Psi - wave function, polygamma function
\newunicodechar{ω}{{\unicodeext ω}}  % Omega - angular frequency, sample space

% Uppercase Greek letters
\newunicodechar{Γ}{{\unicodeext Γ}}  % Gamma - gamma function
\newunicodechar{Δ}{{\unicodeext Δ}}  % Delta - change, difference operator
\newunicodechar{Θ}{{\unicodeext Θ}}  % Theta - parameter space
\newunicodechar{Λ}{{\unicodeext Λ}}  % Lambda - likelihood function
\newunicodechar{Ξ}{{\unicodeext Ξ}}  % Xi
\newunicodechar{Π}{{\unicodeext Π}}  % Pi - product operator
\newunicodechar{Σ}{{\unicodeext Σ}}  % Sigma - summation operator
\newunicodechar{Υ}{{\unicodeext Υ}}  % Upsilon
\newunicodechar{Φ}{{\unicodeext Φ}}  % Phi - cumulative distribution function
\newunicodechar{Χ}{{\unicodeext Χ}}  % Chi
\newunicodechar{Ψ}{{\unicodeext Ψ}}  % Psi
\newunicodechar{Ω}{{\unicodeext Ω}}  % Omega - sample space, resistance

% Arithmetic and algebra
\newunicodechar{±}{{\unicodeext ±}}  % Plus-minus
\newunicodechar{×}{{\unicodeext ×}}  % Multiplication sign
\newunicodechar{÷}{{\unicodeext ÷}}  % Division sign
\newunicodechar{∞}{{\unicodeext ∞}}  % Infinity

% Comparison and equivalence
\newunicodechar{≠}{{\unicodeext ≠}}  % Not equal to
\newunicodechar{≈}{{\unicodeext ≈}}  % Approximately equal to
\newunicodechar{≡}{{\unicodeext ≡}}  % Identical to
\newunicodechar{≤}{{\unicodeext ≤}}  % Less than or equal to
\newunicodechar{≥}{{\unicodeext ≥}}  % Greater than or equal to

% Section formatting and line spacing (non-Beamer only)
\makeatletter
\@ifclassloaded{beamer}{}{%
  % Section formatting with heavier weights
  \titleformat{\section}{\Large\bfseries\addfontfeatures{Weight=800}\color{nmuprimaryblue}}{\thesection}{1em}{}
  \titleformat{\subsection}{\large\bfseries\addfontfeatures{Weight=700}\color{nmusecondaryblue}}{\thesubsection}{1em}{}
  \titleformat{\subsubsection}{\normalsize\bfseries\addfontfeatures{Weight=700}\color{nmusecondaryblue}}{\thesubsubsection}{1em}{}
  
  % Line spacing
  \onehalfspacing
}
\makeatother

% NMU Colours
\definecolor{nmuprimaryblue}{HTML}{141C2B}
\definecolor{nmusecondaryblue}{HTML}{132E51}
\definecolor{nmuprimaryyellow}{HTML}{FFCC00}
\definecolor{nmusecondaryyellow}{HTML}{F9B22A}
\definecolor{nmugrey}{HTML}{999999}
\definecolor{nmuhumanities}{HTML}{FFB51B}
\definecolor{nmueducation}{HTML}{F14F13}
\definecolor{nmubusiness}{HTML}{6C284F}
\definecolor{nmusciences}{HTML}{006B34}
\definecolor{nmuhealth}{HTML}{82B74A}
\definecolor{nmuengineering}{HTML}{57BCE9}
\definecolor{nmulaw}{HTML}{5E6EBA}
\definecolor{nmuocean}{HTML}{00AFAA}

% Additional colours for diagrams
\definecolor{vector1color}{RGB}{41, 128, 185} % Blue (colourblind friendly)
\definecolor{vector2color}{RGB}{241, 196, 15}  % Gold / Deep Yellow (colourblind friendly)
\definecolor{planecolor}{RGB}{210, 210, 210}   % Light Gray (neutral plane)
\definecolor{residualcolor}{RGB}{230, 126, 34} % Orange (colourblind friendly)

\usepackage{tikz}
\usepackage{tikz-3dplot}
\usepackage{tkz-euclide}
\usepackage{pgfplots}
\pgfplotsset{compat=newest}

% Essential TikZ libraries
\usetikzlibrary{
    % Core functionality
    arrows.meta,          % Enhanced arrow tips
    calc,                % Coordinate calculations
    intersections,       % Find intersections of paths
    % Mathematical constructs
    angles,              % Draw and mark angles
    quotes,              % Easy angle labelling
    patterns,            % Fill patterns
    decorations.markings,% Path markers and decorations
    % Plotting and graphs
    plotmarks,           % Special markers for plots
    positioning,         % Relative positioning
    fit,                % Fit shapes to sets of coordinates
    3d,                 % 3D plots
    % Shapes and nodes
    shapes.geometric,    % Basic geometric shapes
    shapes.arrows,       % Arrow shapes
    shapes.symbols,      % Mathematical symbols
    shapes.misc,        % Miscellaneous shapes
    % Specialised features
    matrix,             % Matrix arrangements
    automata,           % State machines and graphs
    bending,            % Path bending
    backgrounds,        % Background layers
    chains,             % Linked nodes
    % Scientific/Mathematical
    circuits.ee.IEC,    % Electrical circuits
    datavisualization,  % Advanced data plotting
    math,               % Mathematical symbols and notation
    trees               % Tree structures
}

% PGFPlots styles and configuration
\pgfplotsset{
    % Default options for plots
    every axis/.append style={
        % Lines and ticks
        axis lines=middle,
        tick align=outside,
        % Labels
        xlabel near ticks,
        ylabel near ticks,
        % Grid
        grid=major,
        grid style={gray!30},
        % Size
        width=0.8\textwidth,
        height=0.6\textwidth,
        % Tick label style
        tick label style={font=\small},
        % Legend
        legend style={
            font=\small,
            cells={anchor=west}
        }
    }
}

% Custom TikZ styles for common elements
\tikzset{
    % Node styles
    important node/.style={
        rectangle,
        rounded corners,
        draw=nmuprimaryblue,
        fill=white,
        thick,
        inner sep=5pt
    },
    % Arrow styles
    math arrow/.style={
        ->,
        >=latex,
        thick
    },
    % Connection styles
    connection/.style={
        draw,
        -latex,
        thick
    },
    % Custom coordinate system for plots
    coords/.style={
        color=nmuprimaryblue,
        mark=*,
        thick
    }
}

\usepackage{siunitx}

% Configure siunitx
\sisetup{
  group-separator = {\,},
  group-minimum-digits = 4
}

\usepackage{calc}

\makeatletter
\def\real#1{\strip@pt\dimexpr #1pt\relax}
\makeatother

\usepackage{tabularx}

% Set default table formatting
\setlength{\tabcolsep}{6pt}
\renewcommand{\arraystretch}{1.2}

% Default text colour
\color{nmuprimaryblue}

% Split-level fractions
\usepackage{xfrac}

% Define argmin and argmax operators
\newcommand{\argmin}[1]{\underset{#1}{\operatorname{argmin}} \,}
\newcommand{\argmax}[1]{\underset{#1}{\operatorname{argmax}} \,}
