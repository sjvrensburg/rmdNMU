% Essential Packages (load order optimized for dependencies)
\usepackage{iftex}
\usepackage{fontspec}        % Font management
\usepackage[a4paper, margin=2.54cm]{geometry}        % Page layout
\usepackage{xcolor}         % Color support
\usepackage{graphicx}       % Graphics
\usepackage[protrusion=true]{microtype}

% Math and Symbols
\usepackage{amsmath}        % Core math
\usepackage{amssymb}        % Math symbols
\usepackage{mathtools}
\usepackage{unicode-math}   % Unicode math support
\usepackage{amsfonts}       % Additional math fonts
\usepackage[Scale=0.98,math-style=french]{lete-sans-math}

% Tables and Lists
\usepackage{array}          % Enhanced table support
\usepackage{booktabs}       % Professional tables
\usepackage{longtable}      % Multi-page tables
\usepackage{multirow}       % Complex table layouts
\usepackage{enumitem}       % List customization

% Links and References
\usepackage{hyperref}       % Load late for compatibility
\usepackage{bookmark}       % PDF bookmarks
\usepackage{cleveref}       % Smart cross-references
\usepackage{xurl}          % URL handling

% Code and Verbatim
\usepackage{fancyvrb}      % Verbatim text
\usepackage{fvextra}       % Extended verbatim
\usepackage{upquote}       % Proper quotes in verbatim
\usepackage[scale=0.95]{FiraMono}
\usepackage[verbatim]{lstfiracode}  % Code listings

\usepackage{emoji}

% Layout and Spacing
\usepackage{setspace}      % Line spacing
\usepackage{parskip}       % Paragraph spacing
\usepackage{titlesec}      % Section formatting

% Core font setup
\defaultfontfeatures{
    Ligatures=TeX,
    UprightFeatures={Weight=400},
    BoldFeatures={Weight=700},
    ItalicFeatures={Weight=400},
    BoldItalicFeatures={Weight=700}
}

% Unicode fallback without affecting main branding
\newfontfamily\unicodeext{DejaVu Serif}[
  Scale=MatchLowercase,
  Range={0250-02AF}  % IPA Extensions only
]
\usepackage{newunicodechar}
% Lowercase Greek letters
\newunicodechar{α}{{\unicodeext α}}  % Alpha - significance level, learning rate
\newunicodechar{β}{{\unicodeext β}}  % Beta - regression coefficients, Type II error
\newunicodechar{γ}{{\unicodeext γ}}  % Gamma - gamma function, regularisation parameter
\newunicodechar{δ}{{\unicodeext δ}}  % Delta - small change, Kronecker delta
\newunicodechar{ε}{{\unicodeext ε}}  % Epsilon - error term, small positive number
\newunicodechar{ζ}{{\unicodeext ζ}}  % Zeta - Riemann zeta function
\newunicodechar{η}{{\unicodeext η}}  % Eta - learning rate, efficiency
\newunicodechar{θ}{{\unicodeext θ}}  % Theta - angle, parameter vector
\newunicodechar{ι}{{\unicodeext ι}}  % Iota - inclusion operator
\newunicodechar{κ}{{\unicodeext κ}}  % Kappa - curvature, condition number
\newunicodechar{λ}{{\unicodeext λ}}  % Lambda - eigenvalue, regularisation parameter
\newunicodechar{μ}{{\unicodeext μ}}  % Mu - population mean, measure
\newunicodechar{ν}{{\unicodeext ν}}  % Nu - degrees of freedom, frequency
\newunicodechar{ξ}{{\unicodeext ξ}}  % Xi - random variable
\newunicodechar{π}{{\unicodeext π}}  % Pi - 3.14159..., probability
\newunicodechar{ρ}{{\unicodeext ρ}}  % Rho - correlation coefficient, density
\newunicodechar{σ}{{\unicodeext σ}}  % Sigma - standard deviation, summation
\newunicodechar{τ}{{\unicodeext τ}}  % Tau - time constant, 2π
\newunicodechar{υ}{{\unicodeext υ}}  % Upsilon - degrees of freedom
\newunicodechar{φ}{{\unicodeext φ}}  % Phi - golden ratio, normal distribution
\newunicodechar{χ}{{\unicodeext χ}}  % Chi - chi-squared distribution
\newunicodechar{ψ}{{\unicodeext ψ}}  % Psi - wave function, polygamma function
\newunicodechar{ω}{{\unicodeext ω}}  % Omega - angular frequency, sample space

% Uppercase Greek letters
\newunicodechar{Γ}{{\unicodeext Γ}}  % Gamma - gamma function
\newunicodechar{Δ}{{\unicodeext Δ}}  % Delta - change, difference operator
\newunicodechar{Θ}{{\unicodeext Θ}}  % Theta - parameter space
\newunicodechar{Λ}{{\unicodeext Λ}}  % Lambda - likelihood function
\newunicodechar{Ξ}{{\unicodeext Ξ}}  % Xi
\newunicodechar{Π}{{\unicodeext Π}}  % Pi - product operator
\newunicodechar{Σ}{{\unicodeext Σ}}  % Sigma - summation operator
\newunicodechar{Υ}{{\unicodeext Υ}}  % Upsilon
\newunicodechar{Φ}{{\unicodeext Φ}}  % Phi - cumulative distribution function
\newunicodechar{Χ}{{\unicodeext Χ}}  % Chi
\newunicodechar{Ψ}{{\unicodeext Ψ}}  % Psi
\newunicodechar{Ω}{{\unicodeext Ω}}  % Omega - sample space, resistance

% Arithmetic and algebra
\newunicodechar{±}{{\unicodeext ±}}  % Plus-minus
\newunicodechar{×}{{\unicodeext ×}}  % Multiplication sign
\newunicodechar{÷}{{\unicodeext ÷}}  % Division sign
\newunicodechar{∞}{{\unicodeext ∞}}  % Infinity

% Comparison and equivalence
\newunicodechar{≠}{{\unicodeext ≠}}  % Not equal to
\newunicodechar{≈}{{\unicodeext ≈}}  % Approximately equal to
\newunicodechar{≡}{{\unicodeext ≡}}  % Identical to
\newunicodechar{≤}{{\unicodeext ≤}}  % Less than or equal to
\newunicodechar{≥}{{\unicodeext ≥}}  % Greater than or equal to

% Section formatting with heavier weights
\titleformat{\section}{\Large\bfseries\addfontfeatures{Weight=800}\color{nmuprimaryblue}}{\thesection}{1em}{}
\titleformat{\subsection}{\large\bfseries\addfontfeatures{Weight=700}\color{nmusecondaryblue}}{\thesubsection}{1em}{}
\titleformat{\subsubsection}{\normalsize\bfseries\addfontfeatures{Weight=700}\color{nmusecondaryblue}}{\thesubsubsection}{1em}{}

% Common configurations
\providecommand{\tightlist}{
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% Line spacing
\onehalfspacing

% NMU Colours
\definecolor{nmuprimaryblue}{HTML}{141C2B}
\definecolor{nmusecondaryblue}{HTML}{132E51}
\definecolor{nmuprimaryyellow}{HTML}{FFCC00}
\definecolor{nmusecondaryyellow}{HTML}{F9B22A}
\definecolor{nmugrey}{HTML}{999999}
\definecolor{nmuhumanities}{HTML}{FFB51B}
\definecolor{nmueducation}{HTML}{F14F13}
\definecolor{nmubusiness}{HTML}{6C284F}
\definecolor{nmusciences}{HTML}{006B34}
\definecolor{nmuhealth}{HTML}{82B74A}
\definecolor{nmuengineering}{HTML}{57BCE9}
\definecolor{nmulaw}{HTML}{5E6EBA}
\definecolor{nmuocean}{HTML}{00AFAA}

% Additional colours for diagrams
\definecolor{vector1color}{RGB}{41, 128, 185} % Blue (colorblind friendly)
\definecolor{vector2color}{RGB}{241, 196, 15}  % Gold / Deep Yellow (colorblind friendly)
\definecolor{planecolor}{RGB}{210, 210, 210}   % Light Gray (neutral plane)
\definecolor{residualcolor}{RGB}{230, 126, 34} % Orange (colorblind friendly)


\usepackage{tikz}
\usepackage{tikz-3dplot}
\usepackage{tkz-euclide}
\usepackage{pgfplots}
\pgfplotsset{compat=newest}

% Essential TikZ libraries
\usetikzlibrary{
    % Core functionality
    arrows.meta,          % Enhanced arrow tips
    calc,                % Coordinate calculations
    intersections,       % Find intersections of paths
    % Mathematical constructs
    angles,              % Draw and mark angles
    quotes,              % Easy angle labeling
    patterns,            % Fill patterns
    decorations.markings,% Path markers and decorations
    % Plotting and graphs
    plotmarks,           % Special markers for plots
    positioning,         % Relative positioning
    fit,                % Fit shapes to sets of coordinates
    3d,                 % 3D plots
    % Shapes and nodes
    shapes.geometric,    % Basic geometric shapes
    shapes.arrows,       % Arrow shapes
    shapes.symbols,      % Mathematical symbols
    shapes.misc,        % Miscellaneous shapes
    % Specialized features
    matrix,             % Matrix arrangements
    automata,           % State machines and graphs
    bending,            % Path bending
    backgrounds,        % Background layers
    chains,             % Linked nodes
    % Scientific/Mathematical
    circuits.ee.IEC,    % Electrical circuits
    datavisualization,  % Advanced data plotting
    math,               % Mathematical symbols and notation
    trees               % Tree structures
}

% PGFPlots styles and configuration
\pgfplotsset{
    % Default options for plots
    every axis/.append style={
        % Lines and ticks
        axis lines=middle,
        tick align=outside,
        % Labels
        xlabel near ticks,
        ylabel near ticks,
        % Grid
        grid=major,
        grid style={gray!30},
        % Size
        width=0.8\textwidth,
        height=0.6\textwidth,
        % Tick label style
        tick label style={font=\small},
        % Legend
        legend style={
            font=\small,
            cells={anchor=west}
        }
    }
}

% Custom TikZ styles for common elements
\tikzset{
    % Node styles
    important node/.style={
        rectangle,
        rounded corners,
        draw=nmuprimaryblue,
        fill=white,
        thick,
        inner sep=5pt
    },
    % Arrow styles
    math arrow/.style={
        ->,
        >=latex,
        thick
    },
    % Connection styles
    connection/.style={
        draw,
        -latex,
        thick
    },
    % Custom coordinate system for plots
    coords/.style={
        color=nmuprimaryblue,
        mark=*,
        thick
    }
}

% Image handling settings
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}


\usepackage{siunitx}

% Configure siunitx
\sisetup{
  group-separator = {\,},
  group-minimum-digits = 4
}

\usepackage{calc}

\makeatletter
\def\real#1{\strip@pt\dimexpr #1pt\relax}
\makeatother

\usepackage{tabularx}

% Define column types for tables
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}}
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{R}[1]{>{\raggedleft\arraybackslash}p{#1}}

% Set default table formatting
\setlength{\tabcolsep}{6pt}
\renewcommand{\arraystretch}{1.2}

% Default text color
\color{nmuprimaryblue}

% Split-level fractions
\usepackage{xfrac}

% Define argmin and argmax operators
\newcommand{\argmin}[1]{\underset{#1}{\operatorname{argmin}} \,}
\newcommand{\argmax}[1]{\underset{#1}{\operatorname{argmax}} \,}

% Define command for the compatibility with new Pandoc
\providecommand{\pandocbounded}[1]{#1}
