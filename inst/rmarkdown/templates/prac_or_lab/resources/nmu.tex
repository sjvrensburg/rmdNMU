\documentclass[11pt,a4paper]{article}

% Load essential packages first
\usepackage{fontspec}
\usepackage{amssymb}
\usepackage{unicode-math}
\usepackage{microtype}
\usepackage{graphicx}
\usepackage{fancyvrb}
\usepackage{xcolor}
\usepackage{bookmark}
\usepackage{xurl}
\usepackage{geometry}
\usepackage{setspace}
\usepackage{parskip}
\usepackage{titlesec}
\usepackage{listings}
\usepackage{amsmath}
\usepackage{amsfonts}

\usepackage{tabularx}
\usepackage{array}
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{multirow}

\usepackage{calc}  % For length calculations
\makeatletter
\def\real#1{\strip@pt\dimexpr #1pt\relax}
\makeatother

% Define column types for tables
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}}
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{R}[1]{>{\raggedleft\arraybackslash}p{#1}}

% Set default table formatting
\setlength{\tabcolsep}{6pt}
\renewcommand{\arraystretch}{1.2}

% Basic setup for microtype
\SetProtrusion
  [ name     = microtype-default,
    load     = microtype-default ]
  { }
  { }

% Define colors (matching short notes)
\definecolor{nmuprimaryblue}{HTML}{141C2B}
\definecolor{nmusecondaryblue}{HTML}{132E51}
\definecolor{nmuprimaryyellow}{HTML}{FFCC00}
\definecolor{nmusecondaryyellow}{HTML}{F9B22A}

% Set page geometry
\geometry{margin=2.54cm}

% Font configuration
\defaultfontfeatures{
    Ligatures=TeX,
    UprightFeatures={Weight=400},
    BoldFeatures={Weight=700},
    ItalicFeatures={Weight=400},
    BoldItalicFeatures={Weight=700}
}

\setmainfont{Nunito Sans}[
    Extension = .ttf,
    Path = $fontdir$/,
    UprightFont = NunitoSans-Regular,
    ItalicFont = NunitoSans-Italic,
    BoldFont = NunitoSans-Regular,
    BoldItalicFont = NunitoSans-Italic,
    UprightFeatures = {
        Weight=450,
        Scale=1.0
    },
    BoldFeatures = {
        Weight=700
    },
    ItalicFeatures = {
        Weight=450
    },
    BoldItalicFeatures = {
        Weight=700
    }
]

% Code highlighting from pandoc
$highlighting-macros$

% Section formatting
\titleformat{\section}{\Large\bfseries\color{nmuprimaryblue}}{\thesection}{1em}{}
\titleformat{\subsection}{\large\bfseries\color{nmusecondaryblue}}{\thesubsection}{1em}{}
\titleformat{\subsubsection}{\normalsize\bfseries\color{nmusecondaryblue}}{\thesubsubsection}{1em}{}

% List formatting
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% URL styling
\urlstyle{same}

% Code listing configuration
\lstset{
    backgroundcolor=\color{gray!10},
    basicstyle=\small\ttfamily,
    breaklines=true,
    captionpos=b,
    commentstyle=\color{gray},
    keywordstyle=\color{nmusecondaryblue},
    stringstyle=\color{nmusecondaryyellow},
    numbers=left,
    numberstyle=\tiny\color{gray},
    frame=single,
    framesep=3pt,
    rulecolor=\color{gray!30},
    showstringspaces=false
}

% Set line spacing
\onehalfspacing

% PDF metadata and hyperref setup
\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=nmusecondaryblue,
    filecolor=nmusecondaryblue,
    urlcolor=nmusecondaryblue,
    citecolor=nmusecondaryblue,
    pdftitle={$title-meta$},
    pdfauthor={$author-meta$},
    pdfcreator={LaTeX via pandoc}
}

% Bibliography setup if needed
$if(bibliography)$
\usepackage[
   backend=biber,
   $if(biblatex-style)$
   style=$biblatex-style$,
   $endif$
   $if(biblio-style)$
   style=$biblio-style$,
   $endif$
   $if(csl)$
   style=authoryear,
   $endif$
   sorting=none
]{biblatex}
$if(bibliography)$
\addbibresource{$bibliography$}
$endif$
$endif$

% Title information with defaults
\title{$if(title)$$title$$else$\vspace{-3em}$endif$}
\author{$if(author)$$author$$else$\vspace{-3em}$endif$}
\date{$if(date)$$date$$else$\vspace{-3em}$endif$}

% Custom title page
\makeatletter
\renewcommand{\maketitle}{%
    \begin{center}
        $if(title)$
        {\huge\bfseries\color{nmuprimaryblue}\@title\par}
        \vspace{0.5em}
        $endif$
        $if(author)$
        {\large\color{nmusecondaryblue}\@author\par}
        \vspace{0.5em}
        $endif$
        $if(date)$
        {\large\color{nmusecondaryblue}\@date\par}
        $endif$
    \end{center}
    \vspace{1em}
}
\makeatother

\begin{document}
\maketitle

$body$

$if(bibliography)$
\printbibliography
$endif$

\end{document}
