$if(params.solutions)$
\documentclass[answers, addpoints]{exam}
$else$
\documentclass[addpoints]{exam}
$endif$

% Handle font size with extsizes
\usepackage[$if(fontsize)$$fontsize$$else$12pt$endif$]{extsizes}

% Load basic packages first
\usepackage{fontspec}
\usepackage{amssymb}
\usepackage{unicode-math}
\usepackage{microtype}
\usepackage{graphicx}

% Image handling settings
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}

\usepackage[hidelinks]{hyperref}
\usepackage{enumitem}
\usepackage{xcolor}
\usepackage{siunitx}
\usepackage{soul}
\usepackage{tabularx}
\usepackage{array}
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{multirow}

\usepackage{calc}  % For length calculations
\makeatletter
\def\real#1{\strip@pt\dimexpr #1pt\relax}
\makeatother

% Define column types for tables
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}}
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{R}[1]{>{\raggedleft\arraybackslash}p{#1}}

% Set default table formatting
\setlength{\tabcolsep}{6pt}
\renewcommand{\arraystretch}{1.2}

% Font configuration
\defaultfontfeatures{
    Ligatures=TeX,
    UprightFeatures={Weight=400},  % Regular weight for normal text
    BoldFeatures={Weight=700},     % Bold weight
    ItalicFeatures={Weight=400},   % Regular weight for italics
    BoldItalicFeatures={Weight=700} % Bold weight for bold italics
}

\setmainfont{Nunito Sans}[
    Extension = .ttf,
    Path = $fontdir$/,
    UprightFont = NunitoSans-Regular,
    ItalicFont = NunitoSans-Italic,
    BoldFont = NunitoSans-Regular,   % Using Regular font with weight variation
    BoldItalicFont = NunitoSans-Italic,  % Using Italic font with weight variation
    % Font Features section
    UprightFeatures = {
        Weight=450,  % Slightly heavier than regular for better readability
        Scale=1.0
    },
    BoldFeatures = {
        Weight=700  % Bold
    },
    ItalicFeatures = {
        Weight=450  % Matching upright weight
    },
    BoldItalicFeatures = {
        Weight=700  % Bold italic
    }
]

\setmathfont{KpMath-Sans}[
    Scale=MatchUppercase,
    StylisticSet=1
]

% For bold math symbols
\AtBeginDocument{
    \let\origbold\mathbf
    \renewcommand{\mathbf}[1]{\symbfit{#1}}
}

\usepackage[scale=0.95]{FiraMono}

% Emojis! What's a test without emojis?
\usepackage{emoji}

% Define NMU colors
\definecolor{nmuprimaryblue}{HTML}{141C2B}
\definecolor{nmusecondaryblue}{HTML}{132E51}
\definecolor{nmuprimaryyellow}{HTML}{FFCC00}
\definecolor{nmusecondaryyellow}{HTML}{F9B22A}

% Configure siunitx
\sisetup{
  group-separator = {\,},
  group-minimum-digits = 4
}

% Tightlist environment
\setlength{\emergencystretch}{3em}
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

% Code highlighting
$if(highlighting-macros)$
$highlighting-macros$
\usepackage[verbatim]{lstfiracode}
$endif$

% Spacing
\usepackage{setspace}
\onehalfspacing
\marksnotpoints

% Style exam pages
\pagestyle{headandfoot}
\runningheadrule
\firstpageheader%
{\color{nmuprimaryblue}\large \textbf{$header.front.left$}}%
{\color{nmuprimaryblue}\large \textbf{$header.front.center$}}%
{\color{nmuprimaryblue}\large \textbf{$header.front.right$}}

\runningheader%
{\color{nmusecondaryblue}\textbf{$header.running.left$}}%
{\color{nmusecondaryblue}\textbf{$header.running.center$}}%
{\color{nmusecondaryblue}\textbf{$header.running.right$}}

\firstpagefooter%
{\color{nmusecondaryblue}\textbf{$footer.front.left$}}%
{\color{nmusecondaryblue}\textbf{$footer.front.center$}}%
{\color{nmusecondaryblue}\textbf{$footer.front.right$}}

\runningfooter%
{\color{nmusecondaryblue}\textbf{$footer.running.left$}}%
{\color{nmusecondaryblue}\textbf{$footer.running.center$}}%
{\color{nmusecondaryblue}\textbf{$footer.running.right$}}

\usepackage{tikz}
\usepackage{pgfplots}
\pgfplotsset{compat=newest}

% Essential TikZ libraries
\usetikzlibrary{
    % Core functionality
    arrows.meta,          % Enhanced arrow tips
    calc,                % Coordinate calculations
    intersections,       % Find intersections of paths
    % Mathematical constructs
    angles,              % Draw and mark angles
    quotes,              % Easy angle labeling
    patterns,            % Fill patterns
    decorations.markings,% Path markers and decorations
    % Plotting and graphs
    plotmarks,           % Special markers for plots
    positioning,         % Relative positioning
    fit,                % Fit shapes to sets of coordinates
    % Shapes and nodes
    shapes.geometric,    % Basic geometric shapes
    shapes.arrows,       % Arrow shapes
    shapes.symbols,      % Mathematical symbols
    shapes.misc,        % Miscellaneous shapes
    % Specialized features
    matrix,             % Matrix arrangements
    automata,           % State machines and graphs
    bending,            % Path bending
    backgrounds,        % Background layers
    chains,             % Linked nodes
    % Scientific/Mathematical
    circuits.ee.IEC,    % Electrical circuits
    datavisualization,  % Advanced data plotting
    math,               % Mathematical symbols and notation
    trees               % Tree structures
}

% PGFPlots styles and configuration
\pgfplotsset{
    % Default options for plots
    every axis/.append style={
        % Lines and ticks
        axis lines=middle,
        tick align=outside,
        % Labels
        xlabel near ticks,
        ylabel near ticks,
        % Grid
        grid=major,
        grid style={gray!30},
        % Size
        width=0.8\textwidth,
        height=0.6\textwidth,
        % Tick label style
        tick label style={font=\small},
        % Legend
        legend style={
            font=\small,
            cells={anchor=west}
        }
    }
}

% Custom TikZ styles for common elements
\tikzset{
    % Node styles
    important node/.style={
        rectangle,
        rounded corners,
        draw=nmuprimaryblue,
        fill=white,
        thick,
        inner sep=5pt
    },
    % Arrow styles
    math arrow/.style={
        ->,
        >=latex,
        thick
    },
    % Connection styles
    connection/.style={
        draw,
        -latex,
        thick
    },
    % Custom coordinate system for plots
    coords/.style={
        color=nmuprimaryblue,
        mark=*,
        thick
    }
}

\def\tick{
  \begin{tikzpicture}[scale=0.3]
    \draw[fill=black] (0,.35) -- (.25,0) -- (1,.7) -- (.25, .175) -- cycle;
    \node[above, white] at (0.35, 0.1) {\tiny 1};
    \node[below, white] at (0.7, 0.5) {\tiny 2};
  \end{tikzpicture}
}

\def\doubletick{
    \begin{tikzpicture}[scale=0.3]
        \draw[fill=black] (0,.35) -- (.25,0) -- (1,.7) -- (.25, .175) -- cycle;
        \draw[fill=black] (0.5,.35) -- (.75,0) -- (1.5,.7) -- (.75, .175) -- cycle;
        \node[above, white] at (0.35, 0.1) {\tiny 1};
        \node[below, white] at (1.2, 0.5) {\tiny 2};
    \end{tikzpicture}
}

\def\halftick{
    \begin{tikzpicture}[scale=0.3]
        \draw[fill=black] (0,.35) -- (.25,0) -- (1,.7) -- (.25,.15) -- cycle (0.75,0.2) -- (0.77,0.2)  -- (0.6,0.7) -- cycle;
        \node[above] at (0.35, 0.1) {\tiny 1};
        \node[below] at (0.7, 0.5) {\tiny 2};
    \end{tikzpicture}
}

\renewcommand{\droptotalpoints}{
  \hfill
  \fbox{\textbf{Question \thequestion: \totalpoints}}
}

\usepackage{fancyvrb}
\usepackage{upquote}
\usepackage{fvextra}

% Create a custom environment for code in solutions
\makeatletter
\newenvironment{solutioncode}{%
  \VerbatimEnvironment
  \begin{Verbatim}[commandchars=\\\{\},codes={\catcode`\#=12},fontsize=\small]%
}{%
  \end{Verbatim}%
}
\makeatother

% Redefine how code chunks are formatted
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{%
    commandchars=\\\{\},
    codes={\catcode`\#=12},
    fontsize=\small,
    frame=single,
    rulecolor=\color{gray!30},
    framerule=0.5pt,
    framesep=3mm,
    baselinestretch=1.2,
    breaklines=true,
    breakanywhere=true
}

\begin{document}

% Title section
\begin{center}
\begin{tabular}{@{} p{4cm} @{} p{10cm} @{}}
  \toprule
  \textbf{Subject:} & $params.subject$ \\[0.5em]
  \textbf{Module Code:} & $params.code$ \\[0.5em]
  \textbf{Time Limit:} & $params.timelimit$ \\[0.5em]
  \textbf{Marks:} & \numpoints \\[0.5em]
  \textbf{Examiner:} & $params.examiner$ \\
  \bottomrule
\end{tabular}
\end{center}

\vspace{1cm}

% Instructions
$if(params.instructions)$
  $if(params.instructions_file)$
    \input{$params.instructions_file$}
  $else$
    \input{$instructions$}
  $endif$
$endif$

% Points table
$if(params.pointtable)$
  \vspace{1cm}
  \begin{center}
    \gradetable[h][questions]
  \end{center}
  \newpage
$endif$

% Questions section
\begin{questions}
  $body$
\end{questions}

\end{document}
